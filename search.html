<?php 
	include 'php/common.php';

if (empty($_SESSION['me'])) {
    header('Location: '.SITE_URL.'index.html');
    exit;
}

	if(empty($_REQUEST['search_word'])) {
	
		header('Location: index.php');
	}
	
	$user_search = $_REQUEST['search_word'];
	$user_s = mb_convert_kana($user_search,"s","utf-8");
	$not_words = array(",", "、", " ","。",".");
	$clean_search = str_replace($not_words, ' ', $user_s);
	$search_words = explode(" ", $clean_search);
	
	//サーチワードが複数の場合	
	if(count($search_words) > 1) {
	
		foreach($search_words as $word) {
			$where_list2[] = "title collate utf8_unicode_ci LIKE '%$word%' OR";
		}
	
		$where_clause2 = implode(" ", $where_list2);
		$where_clause2 = substr($where_clause2, 0, -2);
		
		//fashion
		$search_fcontents = $dbh->prepare("SELECT * FROM contents_f WHERE $where_clause2 ORDER BY created DESC");
		$search_fcontents->execute();
	
	//サーチワードが１つの場合
	} elseif(count($search_words) == 1) {
	
		$ifone = $search_words[0];
		$search_fcontents = $dbh->prepare("SELECT * FROM contents_f WHERE title collate utf8_unicode_ci LIKE '%$ifone%'");
		$search_fcontents->execute();
	
	}

    $stmt = $dbh->prepare("select * from user_data where id=:request");
    $stmt->execute(array(":request"=>$_SESSION['me']['id']));
    $prof = $stmt->fetch();
?>

<!DOCTYPE html>
<html lang="ja">
<head>

<meta charset="utf-8">
<title>Liry</title>
<meta name="description" content="">
<meta name="keywords" content="">

<!--Require Stylesheet-->
<link rel="shortcut icon" type="image/ico" href="img/favicon.ico" />
<link rel="stylesheet" href="css/common.css">
<link rel="stylesheet" href="css/top.css">

<link rel="stylesheet" href="js/jquery.nailthumb.1.1.min.css">
<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<link rel="stylesheet" href="css/font-awesome.css">
<link href="js/jquery.minimalect.css" type="text/css" rel="stylesheet">
<link href='http://fonts.googleapis.com/css?family=Patua+One' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Kite+One' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Sofia' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Scada' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Flamenco' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Tienne:700' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Tauri' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lily+Script+One' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Share+Tech+Mono' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Signika' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Concert+One' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="css/fontello.css">
<link rel="stylesheet" href="css/animation.css">
<link rel="stylesheet" href="css/fontello-ie7.css">
<link rel="stylesheet" href="css/search.css">
<link rel="stylesheet" href="css/square_thum.css">

</head>
<body>
	<div id="wrapper">
		<div id="wrap-top">
			<header>
				<div id="header">
					<div id="top_logo">
						<a href="index" id="logo_link"><img src="img/LIRY_LOGO2.png" style="height:48px;"/></a>
					</div>
					
					<div id="nav_search">
						<form name="searchform2" id="searchform2" method="get" action="search">  
							<input name="search_word" id="keywords2" value="" type="text" placeholder="#tag search" style="color:#333333;"/>  
							<input type="image" src="img/btn2.gif" alt="検索" id="searchBtn2" />  
						</form>
					</div>
					
					<div id="header_signin">
						<div id="dropdown_menu">
							<ul id="menu">
								<li style="margin-top:5px; margin-left:5px;">
									<a href="#"><i class="fa fa-cogs" style="font-size:150%;">
								</i></a>
								  <ul>
									  <li><a href="userpage/want?id=<?= h($_SESSION['me']['id']); ?>" class="menu_li">Mypage</a></li>
									  <li><a href="mypage_edit" class="menu_li">Setting</a></li>
									  <li><a href="php/logout.php" class="menu_li">Logout</a></li>
								  </ul>
								</li>
							</ul>
						</div>
					
						<div id="user_img_icon">
							<a href="userpage/post"><div class="nailthumb-container square-thumb" style="border:2px solid #333333;">
							    <img src="<?= h($prof['picture']); ?>"/>
							</a>
						</div>
					</div><!--header_signin-->
				
				</div>
			</header>
		
		
		<!--header2-->
		<div id="header2">
			<div id="header2_wrapper">
			<div id="header2_nav">
				<a id="nav_btn_latest" href="index">Latest</a>
				<a id="nav_btn_help" href="help">Help!</a>
				<a id="nav_btn_popular" href="popular">Popular</a>
				<a id="button_example" href="post">POST<i class="fa fa-camera" style="margin-left:3px;"></i></a>
			</div>
			</div>
		</div>
		<div id="search_title_wrapper">
			<div id="search_title">
				<p>Search Result</p>
			</div>
		</div>
		
			<div id="top_content">
				<div id="top_wrapper">
					<div id="question_right">
						<div id="main" role="main">
						 <ul id="tiles">
						 <?php while($all_c = $search_fcontents->fetch(PDO::FETCH_ASSOC)) { ?>
						   <li style="display:none;">
									<div class="help_type">
									<span class="help_type_p"><i class="fa fa-cny" style="font-size:120%;"></i><span class="price" ><?= h($all_c['price']); ?></span></span>
									</div>
									<div class="contents_opacity_wrapper">
										<div class="want_btn_wrapper">
											<form name="like" method="post" action="" class="want_btn2 buy_list_btn_form">			        		
												<input type="hidden" value="<?= $all_c['id']; ?>" name="contents3">
														<?php
														$like = $dbh->prepare("select id from buy_lists where buy_list_user_id=:me AND buy_list_contents_id=:request");
														$like->execute(array(":me"=>$_SESSION['me']['id'],":request"=>$all_c['id']));
														$likes = $like->fetch();
														if(empty($likes)) {
														?>
												<input type="image" class="buy-btns" id="<?= "i_c" . h($all_c['id']); ?>" src="img/buylist_btn_hover_before.png" style="border:0;">
														<?php } else { ?>
												<input type="image" class="buy-btns" id="<?= "i_c" . h($all_c['id']); ?>" src="img/buylist_btn_hover_after.png" style="border:0;">
													<?php } ?>
											</form>
										</div>
										<img src="<?= h($all_c['picture']); ?>" style="width:100%; potision:relateve;" class="item_imgs">
									</div><!--contents_opacity_wrapper-->
									<div class="title_status">
									<?php $title = $all_c['title']; ?>
										<h2 class="title"><a href="contents_detail?id=<?= h($all_c['id']); ?>"><?= mb_strimwidth("$title", 0, 47, "..."); ?></a></h2>
									</div>
									<div class="buy_item_wrapper_left">
										<div class="find_want_status">
											<span class="find_status"><span class="icon_high_set"><i class="fa fa-bookmark" style="font-size:120%;"></i></span>&nbsp;<span class="bookmark" id="<?= "change2" . h($all_c['id']); ?>"><?= h($all_c['buylist_count']); ?></span></span>
										</div>
									    
									    <?php   
										$stmt = $dbh->prepare("select picture, name, prof from user_data where id=:request");
									    $stmt->execute(array(":request"=>$all_c['user_id']));
									    $prof2 = $stmt->fetch();  
									    ?>
									    
										<div class="user_data">
											<div id="user_name_wrapper">    
											<?php $name = $prof2['name']; ?>
												<span class="contents_user_name"><?= mb_strimwidth("$name", 0, 13, "..."); ?></span>
											</div>
											<div class="nailthum_wrapper">  
												<img src="<?= h($prof2['picture']); ?>" style="width:23px; height:23px;"/>
											</div><!--nailthum_wrapper-->
										</div><!--user_data-->
									</div><!--buy_item_wrapper_left-->
									<div class="buy_item_wrapper_right">
										<a class="buy-btn" href="<?= h($all_c['url_link']); ?>">BUY</a>
									</div>
								</li>        
						 <?php } ?>  
						  </ul>
						</div>
					</div><!--question_right-->
				</div><!--top-wrapper-->
			</div><!--content-->
		</div><!--wrap-top-->
	</div><!--wrapper-->
	<div id="loading">
		<img src="img/loading.gif" >
	</div>

	<!--js-->
	<script src="http://code.jquery.com/jquery-latest.js"></script>
	<script src="js/jquery.wookmark.js"></script>
	<script src="js/jquery.nailthumb.1.1.min.js"></script>
	<script src="js/jquery.minimalect.js" type="text/javascript"></script>
	<script>
		$("#menu li").hover(function() {
		$(this).children('ul').show();
	}, function() {
		$(this).children('ul').hide();
	});
		
	</script>
	<script type="text/javascript">
		$(window).load(function(){
			$(document).ready(new function() {
			    var options = {
			      autoResize: true,
			      container: $('#main'),
			      offset: 11,
			      itemWidth: 250   
			    };
			    var handler = $('#tiles li');
			      
			    handler.wookmark(options);
			});
		});
	</script>
	<!--user img icon resize-->
	<script type="text/javascript">
		$(document).ready(function() {
			$('.nailthumb-container').nailthumb({width:40,height:40,method:'crop',fitDirection:'top'});
			$('.nailthumb-container2').nailthumb({width:23,height:23,method:'crop',fitDirection:'top'});
			$('.nailthumb-container3').nailthumb({width:130,height:130,method:'crop',fitDirection:'top'});
			$("#select1").minimalect({ theme: "bubble", placeholder: "ssss" });
		});
	</script>
	<script>
		$(function(){
			$("form.like_form").submit(function(event) {
				event.preventDefault();
				var val = $(this).children("input[name='contents2']").val();
				$.ajax({
					type: 'POST',
					url: 'php/like.php',
					data: {"contents": val},
					success: function(data) {
						var dt = data.split(",");
						var imgSrc = ($("#" + dt[0]).attr("src") == "img/want_btn_before.png")? "img/want_btn_after.png": "img/want_btn_before.png";
						$("#" + dt[0]).attr("src", imgSrc);
						$("span#change" + dt[0]).text(dt[1]);
					}
				});
				return false;
			});
		});
		
	</script> 
	<script>
		$(function(){
			$("form.buy_list_btn_form").submit(function(event) {
				event.preventDefault();
				var val = $(this).children("input[name='contents3']").val();
					$.ajax({
						type: 'POST',
						url: 'php/buy_list_btn.php',
						data: {"contents": val},
						success: function(data) {
							var dt = data.split(",");
							var imgSrc = ($("#i_c" + dt[0]).attr("src") == "img/buylist_btn_hover_before.png")? "img/buylist_btn_hover_after.png": "img/buylist_btn_hover_before.png";
							$("#i_c" + dt[0]).attr("src", imgSrc);
							$("span#change2" + dt[0]).text(dt[1]);
						}
					});
				return false;
			});
		});
		
	</script> 
	<script>
		$(window).load(function(){
			$("#loading").hide();
		});
	</script>
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	
	  ga('create', 'UA-51403977-1', 'liry.me');
	  ga('send', 'pageview');
	
	</script>
</body>
</html>